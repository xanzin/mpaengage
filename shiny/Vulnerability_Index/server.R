#
# This is the server logic of a Shiny web application. You can run the
# application by clicking 'Run App' above.
#
# Find out more about building applications with Shiny here:
#
#    http://shiny.rstudio.com/
#

library(shiny)


normalize <- TRUE

drop_correlated_indicators <- TRUE

template_path <- "report_template.docx"

my_model_structure_file <- "model definitions.xlsx"

my_weights <- read_weights(my_model_structure_file)

my_model_structure <- read_model_structure(my_model_structure_file)

ind_labels <- read_labels(my_model_structure_file)

unlink(list.files(pattern = "tempdir"),recursive = TRUE)

my_column_definitions <- model.structure_to_column.definitions(.model.structure = my_model_structure,
                                                               .weights = my_weights,
                                                               .computing_function = compute_weighted_sum,
                                                               .extra.parameters = list(.na.rm=TRUE,.normalize=normalize))



species_groups <- read_species_groups(my_model_structure_file)

species_groups_levels <- species_groups %>% pull("species_group") %>% unique

my_icons<- read_icons("model definitions.xlsx",.sheet = "Aesthetics") %>%mutate(icon=file.path("www/icons",icon)) %>% filter(file.exists(icon))


# Define server logic required to draw a histogram
shinyServer(function(input, output,session) {
   
   scenarios_data <- data_file_input_server("input_file",.model_definition_file = my_model_structure_file,.column_definitions = my_column_definitions,.model_structure=my_model_structure,.drop_correlated_indicators=drop_correlated_indicators)
   
   
   scenario <- scenarios_dropdown_menu_server("scenarios_menu",reactive(scenarios_data()))
   
   scenarios_download_report_button_server("report",.template_path = template_path,.scenarios_data = reactive(scenarios_data()),.model_structure = my_model_structure,.species_groups = species_groups,.indicator_labels = ind_labels,.icons=my_icons )
   
   output$fileUploaded <- reactive({
      
      return(!is.null(scenarios_data()))
   })
   
   outputOptions(output, 'fileUploaded', suspendWhenHidden=FALSE)
   model_output_tabs_server("MPA_tabs", .data = reactive(scenario()), 
                            .model_structure = my_model_structure,
                            .species_groups = species_groups,
                            .indicator_labels = ind_labels,
                            .icons=my_icons)
   
})
